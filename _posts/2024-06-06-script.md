---
title: 游닆 Creaci칩n del Script
author: mgrl39
date: 2024-06-06
category: Jekyll
layout: post
---

### 1. Creaci칩n del Script

1. Primero, aseg칰rate de estar en el usuario root. Verifica tu ubicaci칩n actual con el comando `pwd`. Luego, mu칠vete al directorio `/root`, donde guardaremos nuestro script:

    ```bash
    cd /root
    ```

    Crea el archivo del script llamado **monitoring.sh** y 치brelo para editar con `vim` (puedes usar cualquier editor de texto que prefieras):

    ```bash
    vim monitoring.sh
    ```

    Recuerda que debes estar en el usuario root. Si no lo est치s, ejecuta `sudo su`.

    ![Imagen 189](https://raw.githubusercontent.com/mgrl39/Born2BeRoot/main/steps/b2br_img_189.png)  

2. Escribe el contenido del script en el archivo. Puedes copiar el contenido del script desde [aqu칤](https://raw.githubusercontent.com/mgrl39/Born2BeRoot/main/monitoring.sh) o descargarlo directamente a tu m치quina con el siguiente comando (si prefieres copiar el contenido manualmente, salta este paso):

    ```bash
    sudo apt install curl -y && curl -O https://raw.githubusercontent.com/mgrl39/Born2BeRoot/main/monitoring.sh
    ```

    ![Imagen 190](https://raw.githubusercontent.com/mgrl39/Born2BeRoot/main/steps/b2br_img_190.png)  

3. Guarda y cierra el archivo `monitoring.sh`, luego ejecuta el script:

    ```bash
    sh monitoring.sh
    ```

    ![Imagen 191](https://raw.githubusercontent.com/mgrl39/Born2BeRoot/main/steps/b2br_img_191.png)  

---

### 2. Configuraci칩n del Cron Job

1. Para que el script se ejecute autom치ticamente cada cierto tiempo, necesitamos configurar un cron job. Abre el archivo crontab para el usuario root:

    ```bash
    sudo crontab -u root -e
    ```

    ![Imagen 193](https://raw.githubusercontent.com/mgrl39/Born2BeRoot/main/steps/b2br_img_193.png)  

2. Si es la primera vez que editas el archivo crontab, se te preguntar치 qu칠 editor quieres usar. Puedes seleccionar `nano` o el que prefieras.

    ![Imagen 192](https://raw.githubusercontent.com/mgrl39/Born2BeRoot/main/steps/b2br_img_192.png) 

3. A침ade la siguiente l칤nea al final del archivo para que el script se ejecute cada 10 minutos:

    ```bash
    */10 * * * * sh /root/monitoring.sh
    ```

    **Explicaci칩n de los par치metros:**

    | Par치metro | Descripci칩n                                                                                                                                          |
    |-----------|------------------------------------------------------------------------------------------------------------------------------------------------------|
    | **m**     | El minuto en que se ejecutar치 el script, el valor va de 0 a 59.                                                                                     |
    | **h**     | La hora en formato de 24 horas, valores de 0 a 23.                                                                                                 |
    | **dom**   | El d칤a del mes. Por ejemplo, 15 para el d칤a 15 de cada mes.                                                                                         |
    | **dow**   | El d칤a de la semana, num칠rico (0 a 7, donde 0 y 7 son domingo) o las primeras tres letras en ingl칠s.                                               |
    | **user**  | El usuario que ejecutar치 el comando. Si no se especifica, usar치 el usuario predeterminado del entorno.                                                |
    | **command** | El comando o la ruta absoluta del script a ejecutar.                                                                                               |

    En este caso:

    | Par치metro  | Valor                | Descripci칩n                                                                |
    |------------|----------------------|----------------------------------------------------------------------------|
    | **m**      | `*/10`               | El script se ejecutar치 cada 10 minutos.                                    |
    | **h**      | `*`                  | Cualquier hora.                                                            |
    | **dom**    | `*`                  | Cualquier d칤a del mes.                                                     |
    | **dow**    | `*`                  | Cualquier d칤a de la semana.                                                 |
    | **user**   | *No especificado*    | Se usar치 el usuario predeterminado.                                        |
    | **command**| `sh /root/monitoring.sh` | Comando para ejecutar el script ubicado en `/root/monitoring.sh`.          |

    ![Imagen 194](https://raw.githubusercontent.com/mgrl39/Born2BeRoot/main/steps/b2br_img_194.png)  

4. Guarda y cierra el archivo crontab. Verifica que el cron job se haya a침adido correctamente:

    ```bash
    crontab -l
    ```

    ![Imagen 195](https://raw.githubusercontent.com/mgrl39/Born2BeRoot/main/steps/b2br_img_195.png)  

### 3. Explicacion Script
#### 1. **Obtener la arquitectura del sistema**

```bash
arch=$(uname -a)
```

- **`uname -a`**: Muestra informaci칩n sobre el sistema operativo, incluyendo el nombre del n칰cleo, la versi칩n, la arquitectura del hardware y otros detalles.

---

#### 2. **Obtener informaci칩n de la CPU**

```bash
cpuf=$(lscpu | awk '/Socket\(s\):/ {print $2}')
cpuv=$(lscpu | awk '/^CPU\(s\):/ {print $2}')
```

- **`lscpu`**: Muestra informaci칩n detallada sobre la arquitectura de la CPU.
- **`awk '/Socket\(s\):/ {print $2}'`**: Extrae el n칰mero de "sockets" f칤sicos (el n칰mero de procesadores f칤sicos).
- **`awk '/^CPU\(s\):/ {print $2}'`**: Extrae el n칰mero total de CPUs virtuales (o hilos).

---

#### 3. **Obtener informaci칩n de la RAM**

```bash
ram_total=$(free -m | awk '/Mem:/ {print $2}')
ram_use=$(free -m | awk '/Mem:/ {print $3}')
ram_percent=$(free -m | awk '/Mem:/ {printf("%.2f"), $3/$2*100}')
```

- **`free -m`**: Muestra la memoria disponible y utilizada en megabytes.
- **`awk '/Mem:/ {print $2}'`**: Extrae la cantidad total de RAM.
- **`awk '/Mem:/ {print $3}'`**: Extrae la cantidad de RAM utilizada.
- **`awk '/Mem:/ {printf("%.2f"), $3/$2*100}'`**: Calcula el porcentaje de RAM utilizada.

---

#### 4. **Obtener informaci칩n del disco**

```bash
disk_total=$(df -h --total | awk '/^total/ {print $2}')
disk_use=$(df -h --total | awk '/^total/ {print $3}')
disk_percent=$(df -h --total | awk '/^total/ {print $5}')
```

- **`df -h --total`**: Muestra el uso del disco en formato legible por humanos, incluyendo el total.
- **`awk '/^total/ {print $2}'`**: Extrae el tama침o total del disco.
- **`awk '/^total/ {print $3}'`**: Extrae el espacio usado en el disco.
- **`awk '/^total/ {print $5}'`**: Extrae el porcentaje de uso del disco.

---

#### 5. **Obtener la carga de la CPU**

```bash
cpu1=$(vmstat 1 2 | tail -1 | awk '{printf $15}')
cpu_op=$(expr 100 - $cpu1)
cpu_fin=$(printf "%.1f" $cpu_op)
```

- **`vmstat 1 2`**: Muestra estad칤sticas de la m치quina virtual de forma continua durante 1 segundo, luego obtiene 2 muestras.
- **`tail -1`**: Obtiene la 칰ltima l칤nea de la salida, que contiene los datos de carga.
- **`awk '{printf $15}'`**: Extrae el porcentaje de tiempo de inactividad de la CPU.
- **`expr 100 - $cpu1`**: Calcula el porcentaje de uso de la CPU (100% menos el porcentaje de inactividad).
- **`printf "%.1f" $cpu_op`**: Formatea el resultado con un decimal.

---

#### 6. **Obtener la 칰ltima vez que se inici칩 el sistema**

```bash
last_boot=$(who -b | awk '{print $3, $4}')
```

- **`who -b`**: Muestra la 칰ltima vez que el sistema fue arrancado.
- **`awk '{print $3, $4}'`**: Extrae la fecha y la hora del 칰ltimo arranque.

---

#### 7. **Verificar si LVM est치 activo**

```bash
lvmu=$(lsblk | grep -q "lvm" && echo "yes" || echo "no")
```

- **`lsblk`**: Muestra informaci칩n sobre los dispositivos de bloque.
- **`grep -q "lvm"`**: Busca la palabra "lvm" en la salida.
- **`&& echo "yes" || echo "no"`**: Devuelve "yes" si LVM est치 presente, de lo contrario "no".

---

#### 8. **Contar el n칰mero de conexiones TCP activas**

```bash
tcp_conn=$(ss -tan | grep -c ESTAB)
```

- **`ss -tan`**: Muestra las conexiones de red TCP.
- **`grep -c ESTAB`**: Cuenta el n칰mero de conexiones establecidas.

---

#### 9. **Contar el n칰mero de usuarios conectados**

```bash
user_log=$(who | wc -l)
```

- **`who`**: Muestra qui칠n est치 actualmente conectado.
- **`wc -l`**: Cuenta el n칰mero de l칤neas, que corresponde al n칰mero de usuarios conectados.

---

#### 10. **Obtener la direcci칩n IP y la direcci칩n MAC**

```bash
ip=$(hostname -I)
mac=$(ip link show | awk '/link\/ether/ {print $2}')
```

- **`hostname -I`**: Muestra todas las direcciones IP asignadas a la m치quina.
- **`ip link show`**: Muestra detalles de las interfaces de red.
- **`awk '/link\/ether/ {print $2}'`**: Extrae la direcci칩n MAC.

---

#### 11. **Contar el n칰mero de comandos ejecutados con sudo**

```bash
sudo_cmd=$(journalctl _COMM=sudo | grep COMMAND | wc -l)
```

- **`journalctl _COMM=sudo`**: Muestra entradas del registro relacionadas con el comando `sudo`.
- **`grep COMMAND`**: Filtra las l칤neas que contienen la palabra "COMMAND".
- **`wc -l`**: Cuenta el n칰mero de l칤neas que corresponden a los comandos ejecutados con `sudo`.

---

#### 12. **Mostrar toda la informaci칩n en todos los terminales**

```bash
wall "Architecture: $arch
    CPU physical: $cpuf
    vCPU: $cpuv
    Memory Usage: $ram_use/${ram_total}MB ($ram_percent%)
    Disk Usage: $disk_use/$disk_total ($disk_percent)
    CPU load: $cpu_fin%
    Last boot: $last_boot
    LVM use: $lvmu
    Connections TCP: $tcp_conn ESTABLISHED
    User log: $user_log
    Network: IP $ip ($mac)
    Sudo: $sudo_cmd cmd"
```

- **`wall`**: Env칤a un mensaje a todos los usuarios conectados. El mensaje incluye toda la informaci칩n recopilada por el script.
